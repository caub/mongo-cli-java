
<h1>Mongo console</h1>
<a href="http://api.mongodb.org/java/current/com/mongodb/DBCollection.html">using java-API</a>
<pre>
send({fn:'insert', args:[[{a:3}]]}, function(d){console.log(d)})
send({fn:'find', args:[{}]}, function(d){console.log(d)})
</pre>

<p>For having the ability to put _canRead, _canUpsert and _canRemove fields in inserted documents, sign in using OpenID</p>
  <pre>
send({fn:'insert', args:[[{a:4,_canRead:['cyril.auburtin@gmail.com']}]]}, function(d){console.log(d)})
send({fn:'find', args:[{a:4}]}, function(d){console.log(d)}) //returns it if you're this user ^, try with your email
</pre>


<div id=openid>
    <button  data-url='https://www.google.com/accounts/o8/id'>Google</button>
    <button data-url='http://open.login.yahooapis.com/openid20/www.yahoo.com/xrds'>Yahoo</button>
</div>
<div id="authed" style="display:none">
    <h3>Hello <b id=email></b></h3>
    <button id="logout"  >Logout</button>
</div>

<script src="//code.jquery.com/jquery-latest.js"></script>
<script>
var coll = 'foo';
var token = document.cookie.replace(/(?:(?:^|.*;\s*)wscb\s*\=\s*([^;]*).*$)|^.*$/, "$1");

//var host = 'http://a.cyril.eu.cloudbees.net';
var host = 'http://mongo-cli-java.herokuapp.com';
//var host = 'http://localhost:8080';

var ws = new WebSocket(host.replace('http','ws')+'/api/'+coll+'?token='+token);

ws.onopen    = function()  {
  console.log('[*] open');
  if (token){
    send({fn:'auth'}, function(_email){
      email = _email;
      if (email){
        $('#authed').show().find('#email').text(email);
        $('#openid').hide();
      }
    });
  }
};

ws.onmessage = function(e) {

  var r=JSON.parse(e.data);
  if (cbs[r._i]){
    cbs[r._i](r.msg);
    cbs[r._i]=undefined;
  }else{
    console.log('[.] message', e.data);
  }
};
ws.onclose   = function()  {console.log('[*] close');};
setInterval(function(){ send({fn:'echo', msg:'ping!'},function(r){console.debug(r)}) }, 20000 );

function send(o, cb){
  o._i = firstCbsI();
  cbs[o._i] = cb;
  ws.send(JSON.stringify(o));
}
var cbs=[];
function firstCbsI(){
  var i=0;
  for (; i<cbs.length; i++)
    if (!cbs[i])
      return i;
  return i;
}


$('#logout').click(function(){
  document.cookie='wscb=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/';
  email="";
  token="";
  $('#authed').hide();
  $('#openid').show();

})


$('#openid button').click(function(){
    var popup = window.open( host+'/openid/authenticate?openid_identifier='+encodeURIComponent($(this).data('url')), 'openid_popup', 'width=790,height=580');
    setInterval(function(){
        popup.postMessage("ping", host);
    }, 500);
})

function receiveOpenIdMessage(event){
  console.log(event.data);
  if (event.data){
    var r = JSON.parse(event.data);
    token = r.token;
    email = r.email;
    $('#authed').show().find('#email').text(email);
    $('#openid').hide();
    document.cookie='wscb='+token+'; expires='+new Date(Date.now()+1000*3600*24).toUTCString()+'; path=/';
  }
}
window.addEventListener("message", receiveOpenIdMessage, false);

</script>
